# P3.2 Security Stack - Production Deployment Checklist

## Pre-Deployment Requirements ✅

### 1. Environment Setup
- [ ] Redis server configured and accessible
- [ ] Database connections verified  
- [ ] Cache configuration in `.env` set to `redis`
- [ ] Session driver set to appropriate backend
- [ ] Organization context session handling verified

### 2. Database Migrations
- [x] Security tables created (audit_logs, security_incidents, etc.)
- [ ] **REQUIRED FIX**: Verify audit_logs ID field is auto-increment
- [ ] **REQUIRED FIX**: Add missing columns if needed:
  - audit_logs: request_id column (if required by business logic)
  - security_incidents: organization_id column (for multi-tenant logging)

### 3. Middleware Registration ✅
- [x] AdvancedRateLimitMiddleware in API group
- [x] AuditLoggingMiddleware in API and web groups  
- [x] SecurityHeadersMiddleware in global middleware
- [x] AuthenticateBearerToken as middleware alias
- [x] All aliases registered in Kernel.php

### 4. Configuration Files ✅
- [x] SecurityService registered in service container
- [x] Rate limiting configuration suitable for production load
- [x] Security headers configuration appropriate for domain
- [x] API authentication configuration validated

## Deployment Steps

### 1. Code Deployment
```bash
# Deploy P3.2 security files
php artisan clear-compiled
php artisan config:cache
php artisan route:cache
php artisan view:cache
```

### 2. Database Updates (if needed)
```sql
-- Fix audit_logs ID field (if needed)
ALTER TABLE audit_logs MODIFY id BIGINT UNSIGNED AUTO_INCREMENT;

-- Add missing columns (if needed)
ALTER TABLE audit_logs ADD COLUMN request_id VARCHAR(255) NULL;
ALTER TABLE security_incidents ADD COLUMN organization_id BIGINT UNSIGNED NULL;
```

### 3. Cache & Queue Setup
```bash
# Clear and warm up cache
php artisan cache:clear
php artisan queue:restart

# Test Redis connectivity
php artisan tinker --execute="echo Cache::store('redis')->get('test') ? 'OK' : 'Configuring...'"
```

### 4. Permissions & Security
```bash
# Set appropriate file permissions
chmod -R 755 storage/
chmod -R 644 storage/logs/

# Verify security headers are working
curl -I https://yourdomain.com/api/health
```

## Post-Deployment Validation

### 1. API Authentication Test
```bash
# Test bearer token authentication
curl -H "Authorization: Bearer YOUR_API_KEY" \
     -H "Content-Type: application/json" \
     https://yourdomain.com/api/send

# Expected: Either successful response or proper 401/403 error
```

### 2. Rate Limiting Validation
```bash
# Test rate limiting (should trigger after configured limit)
for i in {1..10}; do
  curl https://yourdomain.com/api/health
  sleep 1
done

# Expected: 429 Too Many Requests after limit reached
```

### 3. Security Headers Check
```bash
# Verify security headers are present
curl -I https://yourdomain.com/

# Expected headers:
# X-Frame-Options: DENY
# X-Content-Type-Options: nosniff
# X-XSS-Protection: 1; mode=block
# Content-Security-Policy: default-src 'self'
```

### 4. Organization Context Test
```bash
# Test multi-tenant isolation
php artisan tinker --execute="
$org1 = Organization::find(1);
$org2 = Organization::find(2);
echo 'Org 1 API Keys: ' . $org1->apiKeys->count();
echo 'Org 2 API Keys: ' . $org2->apiKeys->count();
"
```

### 5. Audit Logging Test
```bash
# Generate test request and verify logging
curl https://yourdomain.com/api/health

# Check audit logs
php artisan tinker --execute="
echo 'Recent audit logs: ' . AuditLog::count();
echo 'Latest entry: ' . AuditLog::latest()->first()->event_type ?? 'None';
"
```

## Monitoring Setup

### 1. Security Metrics Dashboard
- Rate limiting violations per organization
- Failed authentication attempts
- Security incident trends
- API usage patterns by organization

### 2. Alerts Configuration
- High rate of authentication failures
- Rate limiting triggered frequently
- Security incidents requiring immediate attention
- API key usage anomalies

### 3. Log Monitoring
```bash
# Watch security logs
tail -f storage/logs/laravel.log | grep -E "(security|auth|rate_limit)"

# Monitor Redis memory usage
redis-cli info memory
```

## Performance Benchmarks

### Expected Performance Impact
- **API Response Time**: +5-15ms (acceptable)
- **Memory Usage**: +2-5MB per request (within limits)
- **Redis Operations**: <1ms per rate limit check
- **Database Queries**: +1-2 queries per request for audit logging

### Load Testing Commands
```bash
# Test API with security middleware under load
ab -n 1000 -c 10 -H "Authorization: Bearer YOUR_API_KEY" \
   https://yourdomain.com/api/health

# Monitor resource usage during load test
top -p $(pgrep php-fpm)
```

## Rollback Plan

### If Issues Occur:
1. **Disable P3.2 middleware temporarily**:
   ```php
   // Comment out in Kernel.php
   // \App\Http\Middleware\AdvancedRateLimitMiddleware::class,
   // \App\Http\Middleware\AuditLoggingMiddleware::class,
   ```

2. **Revert to basic authentication**:
   ```php
   // Use standard Laravel throttle middleware
   'throttle:60,1' // instead of advanced.rate.limit
   ```

3. **Clear problematic cache**:
   ```bash
   php artisan cache:clear
   php artisan config:clear
   ```

## Sign-off Checklist

- [ ] All middleware operational in production environment
- [ ] API authentication working with organization context
- [ ] Rate limiting effective and not blocking legitimate traffic
- [ ] Security headers properly configured for domain
- [ ] Audit logging capturing required information
- [ ] Performance impact within acceptable limits
- [ ] Monitoring and alerting configured
- [ ] Team trained on new security features

---
**Deployment Lead**: _________________ **Date**: _________
**Security Review**: ________________ **Date**: _________
**Production Ready**: ✅ / ❌
