# â˜ï¸ Cloudflare R2 Integration untuk WhatsApp Session Storage

> **Panduan Lengkap**: Implementasi Cloudflare R2 sebagai backend storage untuk WhatsApp session pada Blazz Platform.

---

## ğŸ“‘ Daftar Isi

1. [Overview](#overview)
2. [Mengapa Cloudflare R2?](#mengapa-cloudflare-r2)
3. [Arsitektur](#arsitektur)
4. [Mekanisme Kerja](#mekanisme-kerja)
5. [Setup & Konfigurasi](#setup--konfigurasi)
6. [Implementasi Code](#implementasi-code)
7. [Docker Integration](#docker-integration)
8. [Security](#security)
9. [Monitoring & Maintenance](#monitoring--maintenance)
10. [Troubleshooting](#troubleshooting)
11. [Cost Analysis](#cost-analysis)

---

## Overview

### Problem Statement

Setiap WhatsApp session menggunakan **~19-20MB** storage karena menyimpan full Chromium browser profile:

| Component | Size | Description |
|-----------|------|-------------|
| Service Worker | ~12MB | WhatsApp PWA service worker cache |
| Browser Cache | ~6.6MB | HTTP cache, images, fonts |
| IndexedDB | ~212KB | WhatsApp messages database |
| Local Storage | ~16KB | Session tokens, settings |
| **Total** | **~19-20MB** | Per connected WhatsApp account |

### Scaling Problem

| Users | LocalAuth Storage | With R2 Optimization |
|-------|-------------------|---------------------|
| 1 | 19MB | ~100KB (Redis) + 3MB (R2) |
| 100 | 1.9GB | 10MB + 300MB |
| 1,000 | 19GB | 100MB + 3GB |
| 3,000 | **57GB** | 300MB + 9GB |
| 10,000 | **190GB** | 1GB + 30GB |

### Solution

Kombinasi **Redis** (primary, fast access) + **Cloudflare R2** (backup, persistent) memberikan:
- **99.5% pengurangan** storage lokal
- **Zero egress fees** dari R2
- **Auto-recovery** setelah server restart
- **Multi-region redundancy**

---

## Mengapa Cloudflare R2?

### Perbandingan Cloud Storage Providers

| Provider | Storage/GB | Egress/GB | Free Tier | 3000 Users/mo |
|----------|------------|-----------|-----------|---------------|
| **Cloudflare R2** | $0.015 | **$0** | 10GB + 10M ops | **~$0.20** |
| AWS S3 Standard | $0.023 | $0.09 | 5GB (12 bulan) | ~$2.70 |
| Backblaze B2 | $0.006 | 3x free | 10GB | ~$0.10 |
| Google Cloud | $0.020 | $0.12 | 5GB | ~$3.50 |
| MinIO (self-host) | $0 | $0 | Unlimited | $0 |

### Keunggulan R2

1. **Zero Egress Fees** - Tidak ada biaya untuk download data
2. **S3-Compatible API** - Bisa pakai AWS SDK yang sudah ada
3. **Global Edge Network** - Data di-cache di 300+ lokasi Cloudflare
4. **Free Tier Generous** - 10GB storage + 10M Class B ops FREE
5. **Workers Integration** - Bisa tambah serverless logic jika perlu

### Cost Calculation untuk 3000 Users

```
Storage: 9GB Ã— $0.015/GB           = $0.135
Class A (PUT): 3000 Ã— $4.50/1M     = $0.014  
Class B (GET): 90000 Ã— $0.36/1M    = $0.032
Egress: âˆ GB Ã— $0                  = $0.000
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Total:                               $0.181/month

ğŸ‰ GRATIS! (dalam free tier 10GB)
```

---

## Arsitektur

### High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BLAZZ WHATSAPP ARCHITECTURE                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚   Laravel    â”‚â”€â”€â”€â”€â–¶â”‚   WhatsApp   â”‚â”€â”€â”€â”€â–¶â”‚      Cloudflare R2           â”‚â”‚
â”‚  â”‚   Backend    â”‚     â”‚   Service    â”‚     â”‚   (S3-Compatible Storage)    â”‚â”‚
â”‚  â”‚              â”‚     â”‚   (Node.js)  â”‚     â”‚                              â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  blazz-wa-sessions/          â”‚â”‚
â”‚                              â”‚             â”‚  â”œâ”€â”€ workspace_1/            â”‚â”‚
â”‚                              â”‚             â”‚  â”‚   â”œâ”€â”€ session-1.zip       â”‚â”‚
â”‚                              â–¼             â”‚  â”‚   â””â”€â”€ session-2.zip       â”‚â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚  â””â”€â”€ workspace_2/            â”‚â”‚
â”‚                       â”‚    Redis     â”‚     â”‚      â””â”€â”€ session-3.zip       â”‚â”‚
â”‚                       â”‚  (Primary)   â”‚     â”‚                              â”‚â”‚
â”‚                       â”‚  ~100KB/user â”‚     â”‚  Size: ~3MB per user         â”‚â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚  Cost: $0 (free tier 10GB)   â”‚â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Component Responsibilities

| Component | Role | Data Stored | Latency |
|-----------|------|-------------|---------|
| **Redis** | Primary session store | Session state, credentials (~100KB) | ~1ms |
| **Cloudflare R2** | Backup & recovery | Compressed full session (~3MB) | ~50-200ms |
| **Local Temp** | Processing only | Temporary extraction | ~10ms |

### Data Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           DATA FLOW OVERVIEW                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                â”‚
â”‚  â”‚  User   â”‚                                                                â”‚
â”‚  â”‚  App    â”‚                                                                â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                                                â”‚
â”‚       â”‚ 1. Request connect WhatsApp                                         â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     2. Create session      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ Laravel â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚  WhatsApp   â”‚                    â”‚
â”‚  â”‚ Backend â”‚                            â”‚  Service    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                â”‚                            â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                          â”‚                     â”‚                     â”‚      â”‚
â”‚                          â–¼                     â–¼                     â–¼      â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚                   â”‚   Redis     â”‚      â”‚  Puppeteer  â”‚      â”‚   R2     â”‚   â”‚
â”‚                   â”‚  (State)    â”‚      â”‚ (Chromium)  â”‚      â”‚ (Backup) â”‚   â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  Legend:                                                                    â”‚
â”‚  â”€â”€â”€â–¶  Synchronous call                                                     â”‚
â”‚  - - â–¶ Async background job                                                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Mekanisme Kerja

### Flow 1: User Baru Connect WhatsApp (First Time)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLOW: NEW USER AUTHENTICATION                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Step 1: User request connect                                               â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                               â”‚
â”‚  User App â†’ Laravel API â†’ WhatsApp Service                                  â”‚
â”‚                                â”‚                                            â”‚
â”‚                                â–¼                                            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                     â”‚ Check existing      â”‚                                 â”‚
â”‚                     â”‚ session in Redis    â”‚                                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                â”‚                                            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                     â”‚ Not found?          â”‚                                 â”‚
â”‚                     â”‚ Check R2 backup     â”‚                                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                â”‚                                            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                     â”‚ Not found?          â”‚                                 â”‚
â”‚                     â”‚ Generate new QR     â”‚                                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                â”‚                                            â”‚
â”‚  Step 2: QR Code generation    â”‚                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚                                            â”‚
â”‚                                â–¼                                            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                     â”‚ Initialize          â”‚                                 â”‚
â”‚                     â”‚ Puppeteer/Chromium  â”‚                                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                â”‚                                            â”‚
â”‚                                â–¼                                            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                     â”‚ Open WhatsApp Web   â”‚                                 â”‚
â”‚                     â”‚ Generate QR code    â”‚                                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                â”‚                                            â”‚
â”‚                                â–¼                                            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚                     â”‚ Send QR to Laravel  â”‚â”€â”€â”€â”€â”€â–¶â”‚ Display to User â”‚       â”‚
â”‚                     â”‚ via WebSocket/API   â”‚      â”‚ in App          â”‚       â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                             â”‚
â”‚  Step 3: User scans QR with WhatsApp mobile app                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                            â”‚
â”‚                                                                             â”‚
â”‚  Step 4: Authentication success                                             â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                             â”‚
â”‚                                                                             â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                     â”‚ WhatsApp emits      â”‚                                 â”‚
â”‚                     â”‚ 'authenticated'     â”‚                                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                â”‚                                            â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚              â”‚                 â”‚                 â”‚                          â”‚
â”‚              â–¼                 â–¼                 â–¼                          â”‚
â”‚      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚      â”‚ Save state   â”‚  â”‚ Notify       â”‚  â”‚ Schedule     â”‚                  â”‚
â”‚      â”‚ to Redis     â”‚  â”‚ Laravel      â”‚  â”‚ R2 backup    â”‚                  â”‚
â”‚      â”‚ (instant)    â”‚  â”‚ (webhook)    â”‚  â”‚ (async)      â”‚                  â”‚
â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                             â”‚
â”‚  Step 5: Session ready - user can send/receive messages                     â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flow 2: Automatic Backup ke R2 (Background)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLOW: AUTOMATIC BACKUP (Every 10 minutes)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  WhatsApp Client (Running)                                                  â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”‚ Timer triggers every backupSyncIntervalMs (600000 = 10 min)         â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Step 1: Collect session data from Chromium profile              â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   ./temp/session-user1/                                         â”‚       â”‚
â”‚  â”‚   â”œâ”€â”€ Default/                                                  â”‚       â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ IndexedDB/          # WhatsApp messages database      â”‚       â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ https_web.whatsapp.com_0.indexeddb.leveldb/       â”‚       â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ Local Storage/       # Session tokens & settings      â”‚       â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ leveldb/                                          â”‚       â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ Session Storage/     # Temporary session data         â”‚       â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ Service Worker/      # PWA cache (akan di-exclude)    â”‚       â”‚
â”‚  â”‚   â”‚   â””â”€â”€ Cookies              # Auth cookies                   â”‚       â”‚
â”‚  â”‚   â””â”€â”€ session.json             # Session metadata               â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   Total size: ~19MB                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                           â”‚                                 â”‚
â”‚                                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Step 2: Compress to .zip (excluding unnecessary cache)          â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   Excluded:                                                     â”‚       â”‚
â”‚  â”‚   - Service Worker/CacheStorage/  (12MB - tidak perlu)          â”‚       â”‚
â”‚  â”‚   - Cache/                        (6MB - tidak perlu)           â”‚       â”‚
â”‚  â”‚   - GPUCache/                     (temp files)                  â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   Included:                                                     â”‚       â”‚
â”‚  â”‚   - IndexedDB/                    (messages & keys)             â”‚       â”‚
â”‚  â”‚   - Local Storage/                (session credentials)         â”‚       â”‚
â”‚  â”‚   - Cookies                       (auth state)                  â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   Result: session-user1.zip (~2-3MB compressed)                 â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                           â”‚                                 â”‚
â”‚                                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Step 3: Upload to Cloudflare R2                                 â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   PUT https://<account>.r2.cloudflarestorage.com                â”‚       â”‚
â”‚  â”‚       /blazz-wa-sessions/workspace_1/session-user1.zip          â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   Headers:                                                      â”‚       â”‚
â”‚  â”‚     Content-Type: application/zip                               â”‚       â”‚
â”‚  â”‚     x-amz-meta-user-id: 1                                       â”‚       â”‚
â”‚  â”‚     x-amz-meta-workspace-id: 1                                  â”‚       â”‚
â”‚  â”‚     x-amz-meta-backed-up-at: 2025-12-05T10:30:00Z               â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   Response: 200 OK                                              â”‚       â”‚
â”‚  â”‚   ETag: "abc123..."                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                           â”‚                                 â”‚
â”‚                                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Step 4: Cleanup temp files                                      â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   rm -rf ./temp/session-user1/                                  â”‚       â”‚
â”‚  â”‚   rm ./temp/session-user1.zip                                   â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                             â”‚
â”‚  âœ… Backup complete! Next backup in 10 minutes.                             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flow 3: Session Restore (After Server Restart)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLOW: SESSION RESTORE (After Restart)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Server/Container Starts                                                    â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Step 1: Query database for active sessions                      â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   SELECT user_id, workspace_id, instance_id                     â”‚       â”‚
â”‚  â”‚   FROM whatsapp_instances                                       â”‚       â”‚
â”‚  â”‚   WHERE status = 'connected'                                    â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   Result: [                                                     â”‚       â”‚
â”‚  â”‚     { user_id: 1, workspace_id: 1 },                            â”‚       â”‚
â”‚  â”‚     { user_id: 2, workspace_id: 1 },                            â”‚       â”‚
â”‚  â”‚     { user_id: 3, workspace_id: 2 },                            â”‚       â”‚
â”‚  â”‚     ...                                                         â”‚       â”‚
â”‚  â”‚   ]                                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                           â”‚                                 â”‚
â”‚                                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Step 2: For each session, restore in parallel                   â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   Promise.all(sessions.map(async (session) => {                 â”‚       â”‚
â”‚  â”‚     const sessionId = `session-${user_id}-${workspace_id}`;     â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚     // 2a. Check Redis first (fastest)                          â”‚       â”‚
â”‚  â”‚     const redisData = await redis.get(`wa:${sessionId}`);       â”‚       â”‚
â”‚  â”‚     if (redisData) {                                            â”‚       â”‚
â”‚  â”‚       return initializeFromRedis(sessionId, redisData);         â”‚       â”‚
â”‚  â”‚     }                                                           â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚     // 2b. Fallback to R2 backup                                â”‚       â”‚
â”‚  â”‚     const r2Exists = await r2.headObject(sessionId);            â”‚       â”‚
â”‚  â”‚     if (r2Exists) {                                             â”‚       â”‚
â”‚  â”‚       return restoreFromR2(sessionId);                          â”‚       â”‚
â”‚  â”‚     }                                                           â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚     // 2c. No backup found - mark as disconnected               â”‚       â”‚
â”‚  â”‚     return markAsDisconnected(sessionId);                       â”‚       â”‚
â”‚  â”‚   }));                                                          â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                           â”‚                                 â”‚
â”‚                                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Step 3: Restore from R2 (if Redis miss)                         â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   async function restoreFromR2(sessionId) {                     â”‚       â”‚
â”‚  â”‚     // Download .zip from R2                                    â”‚       â”‚
â”‚  â”‚     const zipBuffer = await r2.getObject({                      â”‚       â”‚
â”‚  â”‚       Bucket: 'blazz-wa-sessions',                              â”‚       â”‚
â”‚  â”‚       Key: `workspace_1/${sessionId}.zip`                       â”‚       â”‚
â”‚  â”‚     });                                                         â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚     // Extract to temp directory                                â”‚       â”‚
â”‚  â”‚     await extract(zipBuffer, `./temp/${sessionId}`);            â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚     // Initialize WhatsApp client with restored data            â”‚       â”‚
â”‚  â”‚     const client = new Client({                                 â”‚       â”‚
â”‚  â”‚       authStrategy: new RemoteAuth({                            â”‚       â”‚
â”‚  â”‚         clientId: sessionId,                                    â”‚       â”‚
â”‚  â”‚         dataPath: `./temp/${sessionId}`,                        â”‚       â”‚
â”‚  â”‚         store: r2Store                                          â”‚       â”‚
â”‚  â”‚       })                                                        â”‚       â”‚
â”‚  â”‚     });                                                         â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚     return client.initialize();                                 â”‚       â”‚
â”‚  â”‚   }                                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                           â”‚                                 â”‚
â”‚                                           â–¼                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ Step 4: Auto-reconnect (NO QR scan needed!)                     â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   client.on('ready', () => {                                    â”‚       â”‚
â”‚  â”‚     console.log(`âœ… Session ${sessionId} restored!`);           â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚     // Update Redis with fresh state                            â”‚       â”‚
â”‚  â”‚     redis.set(`wa:${sessionId}`, JSON.stringify({               â”‚       â”‚
â”‚  â”‚       status: 'connected',                                      â”‚       â”‚
â”‚  â”‚       restoredAt: Date.now(),                                   â”‚       â”‚
â”‚  â”‚       phone: client.info.wid.user                               â”‚       â”‚
â”‚  â”‚     }));                                                        â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚     // Notify Laravel                                           â”‚       â”‚
â”‚  â”‚     notifyLaravel('session_restored', sessionId);               â”‚       â”‚
â”‚  â”‚   });                                                           â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚   client.on('auth_failure', () => {                             â”‚       â”‚
â”‚  â”‚     // Session expired/invalid - user needs to re-scan QR       â”‚       â”‚
â”‚  â”‚     markAsDisconnected(sessionId);                              â”‚       â”‚
â”‚  â”‚     deleteR2Backup(sessionId);                                  â”‚       â”‚
â”‚  â”‚   });                                                           â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                             â”‚
â”‚  âœ… All sessions restored in ~30-60 seconds (for 100 users)                 â”‚
â”‚  âœ… Users can continue sending/receiving without re-scanning QR             â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Flow 4: Send/Receive Message (Normal Operation)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FLOW: NORMAL MESSAGE OPERATION                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  SEND MESSAGE:                                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•                                                              â”‚
â”‚                                                                             â”‚
â”‚  Laravel API                                                                â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”‚ POST /api/whatsapp/send                                             â”‚
â”‚       â”‚ { to: "628xxx", message: "Hello!" }                                 â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  WhatsApp Service                                                           â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”‚ 1. Get client from memory (already initialized)                     â”‚
â”‚       â”‚ 2. Validate session from Redis (1ms)                                â”‚
â”‚       â”‚ 3. Send via WhatsApp Web                                            â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  WhatsApp Servers â†’ Recipient                                               â”‚
â”‚                                                                             â”‚
â”‚  âš¡ Latency: ~100-500ms (network to WhatsApp)                               â”‚
â”‚  âš¡ R2 NOT involved in normal messaging                                     â”‚
â”‚                                                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                             â”‚
â”‚  RECEIVE MESSAGE:                                                           â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                           â”‚
â”‚                                                                             â”‚
â”‚  WhatsApp Servers                                                           â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”‚ New message event                                                   â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  WhatsApp Service (listening via Puppeteer)                                 â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â”‚ client.on('message', async (msg) => {                               â”‚
â”‚       â”‚   // Forward to Laravel                                             â”‚
â”‚       â”‚   await axios.post(LARAVEL_WEBHOOK, {                               â”‚
â”‚       â”‚     from: msg.from,                                                 â”‚
â”‚       â”‚     body: msg.body,                                                 â”‚
â”‚       â”‚     timestamp: msg.timestamp                                        â”‚
â”‚       â”‚   });                                                               â”‚
â”‚       â”‚ });                                                                 â”‚
â”‚       â”‚                                                                     â”‚
â”‚       â–¼                                                                     â”‚
â”‚  Laravel Backend â†’ Process â†’ Store â†’ Notify User                            â”‚
â”‚                                                                             â”‚
â”‚  âš¡ R2 NOT involved in normal messaging                                     â”‚
â”‚  âš¡ R2 only used for backup (every 10 min) and restore (on restart)         â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Setup & Konfigurasi

### Step 1: Buat Cloudflare Account & R2 Bucket

1. **Sign up/Login ke Cloudflare Dashboard**
   - https://dash.cloudflare.com/sign-up/r2

2. **Create R2 Bucket**
   ```
   Dashboard â†’ R2 â†’ Create bucket
   
   Bucket name: blazz-wa-sessions
   Location: Automatic (atau pilih region terdekat)
   ```

3. **Generate API Token**
   ```
   Dashboard â†’ R2 â†’ Manage R2 API Tokens â†’ Create API token
   
   Permissions: Object Read & Write
   Specify bucket: blazz-wa-sessions
   TTL: No expiration (atau sesuai kebutuhan)
   ```

4. **Catat credentials**
   ```
   Account ID: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   Access Key ID: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   Secret Access Key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   ```

### Step 2: Environment Variables

Tambahkan ke `.env` WhatsApp Service:

```env
# Cloudflare R2 Configuration
R2_ACCOUNT_ID=your_account_id_here
R2_ACCESS_KEY_ID=your_access_key_here
R2_SECRET_ACCESS_KEY=your_secret_key_here
R2_BUCKET_NAME=blazz-wa-sessions
R2_ENDPOINT=https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com

# Session Backup Configuration
SESSION_BACKUP_ENABLED=true
SESSION_BACKUP_INTERVAL_MS=600000
SESSION_BACKUP_STORE=r2
```

### Step 3: Install Dependencies

```bash
cd whatsapp-service
npm install @aws-sdk/client-s3 archiver unzipper
```

---

## Implementasi Code

Lihat file-file berikut dalam folder ini:
- `R2Store.js` - Class untuk handle R2 operations
- `SessionManager.js` - Updated session manager dengan R2 support
- `backup-scheduler.js` - Background job untuk scheduled backup

---

## Docker Integration

### docker-compose.yaml

```yaml
services:
  whatsapp:
    build: ./whatsapp-service
    environment:
      # Redis (Primary)
      REDIS_URL: redis://redis:6379
      
      # R2 (Backup)
      R2_ACCOUNT_ID: ${R2_ACCOUNT_ID}
      R2_ACCESS_KEY_ID: ${R2_ACCESS_KEY_ID}
      R2_SECRET_ACCESS_KEY: ${R2_SECRET_ACCESS_KEY}
      R2_BUCKET_NAME: blazz-wa-sessions
      
      # Backup config
      SESSION_BACKUP_ENABLED: "true"
      SESSION_BACKUP_INTERVAL_MS: "600000"
    volumes:
      # Minimal temp storage only (NOT for sessions!)
      - /tmp/wa-temp:/app/temp
    tmpfs:
      # RAM-based temp for fast processing
      - /app/cache:size=100M
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes --maxmemory 512mb
    volumes:
      - redis-data:/data

volumes:
  redis-data:
```

### Volume Strategy

| Path | Type | Purpose | Size |
|------|------|---------|------|
| `/app/temp` | tmpfs/small volume | Temporary extraction | ~100MB max |
| `/app/cache` | tmpfs (RAM) | Processing cache | ~100MB |
| `redis-data` | Docker volume | Session state | ~1GB for 10k users |
| **R2 bucket** | Cloud storage | Persistent backup | ~30GB for 10k users |

---

## Security

### Best Practices

1. **Never commit credentials**
   ```gitignore
   # .gitignore
   .env
   .env.local
   *.pem
   ```

2. **Use environment variables**
   ```bash
   # Don't hardcode!
   R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
   ```

3. **Bucket is PRIVATE by default**
   - No public access
   - Access only via API keys

4. **Rotate API keys periodically**
   - Recommended: every 90 days
   - Use Cloudflare API token rotation

5. **Enable bucket versioning** (optional)
   - For disaster recovery
   - Additional cost

### Data Encryption

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ENCRYPTION LAYERS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  1. IN TRANSIT                                                  â”‚
â”‚     â””â”€â”€ HTTPS/TLS 1.3 (automatic)                               â”‚
â”‚                                                                 â”‚
â”‚  2. AT REST                                                     â”‚
â”‚     â””â”€â”€ R2 encrypts all objects (automatic, AES-256)            â”‚
â”‚                                                                 â”‚
â”‚  3. APPLICATION LEVEL (optional)                                â”‚
â”‚     â””â”€â”€ Encrypt .zip before upload                              â”‚
â”‚     â””â”€â”€ Use customer-managed keys                               â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Monitoring & Maintenance

### R2 Metrics to Monitor

1. **Storage Usage**
   - Dashboard â†’ R2 â†’ bucket â†’ Metrics
   - Alert if > 8GB (approaching free tier limit)

2. **Operations Count**
   - Class A (PUT): Should be ~3000/month for 3000 users
   - Class B (GET): Spike during restarts

3. **Error Rate**
   - 4xx errors: Usually permission issues
   - 5xx errors: R2 service issues (rare)

### Cleanup Policy

```javascript
// Lifecycle rule: Delete backups older than 30 days
// (if user hasn't reconnected)

const CLEANUP_CONFIG = {
  maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days
  checkInterval: 24 * 60 * 60 * 1000, // Daily
};

async function cleanupOldBackups() {
  const objects = await r2.listObjects({ Bucket: BUCKET });
  
  for (const obj of objects.Contents) {
    const age = Date.now() - obj.LastModified.getTime();
    if (age > CLEANUP_CONFIG.maxAge) {
      // Check if session is still active in database
      const isActive = await db.isSessionActive(obj.Key);
      if (!isActive) {
        await r2.deleteObject({ Bucket: BUCKET, Key: obj.Key });
      }
    }
  }
}
```

---

## Troubleshooting

### Common Issues

| Issue | Cause | Solution |
|-------|-------|----------|
| `AccessDenied` | Wrong API key | Check R2_ACCESS_KEY_ID |
| `NoSuchBucket` | Bucket doesn't exist | Create bucket in dashboard |
| `SlowUpload` | Large file | Check compression is working |
| `RestoreFailed` | Corrupt backup | Delete backup, user re-scan QR |
| `SessionExpired` | WhatsApp logged out | User must re-scan QR |

### Debug Mode

```bash
# Enable detailed R2 logs
export R2_DEBUG=true
export AWS_SDK_LOAD_CONFIG=1

# Run with verbose
node --inspect server.js
```

### Health Check Endpoint

```javascript
// GET /health/r2
app.get('/health/r2', async (req, res) => {
  try {
    // Test R2 connectivity
    await r2.headBucket({ Bucket: BUCKET });
    
    // Get stats
    const objects = await r2.listObjects({ Bucket: BUCKET, MaxKeys: 1 });
    
    res.json({
      status: 'healthy',
      bucket: BUCKET,
      connected: true,
      sampleObject: objects.Contents?.[0]?.Key
    });
  } catch (error) {
    res.status(500).json({
      status: 'unhealthy',
      error: error.message
    });
  }
});
```

---

## Cost Analysis

### Monthly Cost Breakdown (3000 Users)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    COST BREAKDOWN                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  CLOUDFLARE R2:                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚  Storage: 9GB Ã— $0.015/GB              = $0.135                 â”‚
â”‚  Class A (PUT): 9000 ops Ã— $4.50/1M    = $0.041                 â”‚
â”‚  Class B (GET): 90000 ops Ã— $0.36/1M   = $0.032                 â”‚
â”‚  Egress: unlimited Ã— $0                = $0.000                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚  Subtotal R2:                            $0.208                 â”‚
â”‚                                                                 â”‚
â”‚  ğŸ‰ FREE TIER COVERS THIS!                                      â”‚
â”‚     - 10GB storage (we use 9GB)                                 â”‚
â”‚     - 1M Class A ops (we use 9k)                                â”‚
â”‚     - 10M Class B ops (we use 90k)                              â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚                                                                 â”‚
â”‚  REDIS (Docker):                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                 â”‚
â”‚  Memory: 512MB container                = included in server    â”‚
â”‚                                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€              â”‚
â”‚                                                                 â”‚
â”‚  TOTAL ADDITIONAL COST:                   $0.00/month           â”‚
â”‚                                                                 â”‚
â”‚  vs WITHOUT R2 (LocalAuth):              57GB disk needed       â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Scaling Costs

| Users | R2 Storage | Monthly Cost | Notes |
|-------|------------|--------------|-------|
| 1-3,333 | â‰¤10GB | **$0** | Free tier |
| 5,000 | 15GB | ~$0.08 | Minimal |
| 10,000 | 30GB | ~$0.30 | Still cheap |
| 50,000 | 150GB | ~$2.25 | Very affordable |
| 100,000 | 300GB | ~$4.50 | Enterprise scale |

---

## References

- [Cloudflare R2 Documentation](https://developers.cloudflare.com/r2/)
- [R2 Pricing](https://developers.cloudflare.com/r2/pricing/)
- [AWS SDK for JavaScript v3](https://docs.aws.amazon.com/AWSJavaScriptSDK/v3/latest/)
- [whatsapp-web.js RemoteAuth](https://wwebjs.dev/guide/authentication.html#remote-authentication)
- [wwebjs-aws-s3 Package](https://www.npmjs.com/package/wwebjs-aws-s3)

---

## Quick Start Checklist

- [ ] Create Cloudflare account
- [ ] Create R2 bucket `blazz-wa-sessions`
- [ ] Generate API token with Object Read & Write
- [ ] Add environment variables to `.env`
- [ ] Install npm dependencies
- [ ] Implement R2Store class
- [ ] Update SessionManager
- [ ] Test backup & restore
- [ ] Deploy to Docker
- [ ] Monitor metrics

---

*Document Version: 1.0*
*Last Updated: December 2025*
*Author: Blazz Platform Team*
