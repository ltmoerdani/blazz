# ============================================================================
# GitHub Actions - Docker Build & Test
# ============================================================================
# Runs on: Push to feature/docker-*, staging branches and PRs
# ============================================================================

name: Docker Build & Test

on:
  push:
    branches:
      - 'feature/docker-*'
      - staging
  pull_request:
    branches:
      - staging
      - main

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ==========================================================================
  # Build and Test Laravel App
  # ==========================================================================
  build-app:
    name: Build Laravel App
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Laravel image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/app/Dockerfile
          push: false
          load: true
          tags: blazz/app:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test image runs
        run: |
          docker run --rm blazz/app:test php -v
          docker run --rm blazz/app:test composer --version

  # ==========================================================================
  # Build and Test WhatsApp Service
  # ==========================================================================
  build-whatsapp:
    name: Build WhatsApp Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build WhatsApp image
        uses: docker/build-push-action@v5
        with:
          context: ./whatsapp-service
          file: ./whatsapp-service/Dockerfile
          push: false
          load: true
          tags: blazz/whatsapp:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test image runs
        run: |
          docker run --rm blazz/whatsapp:test node -v
          docker run --rm blazz/whatsapp:test which chromium

  # ==========================================================================
  # Integration Test with Docker Compose
  # ==========================================================================
  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [build-app, build-whatsapp]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create .env file
        run: |
          cp .env.docker.example .env
          echo "APP_KEY=base64:$(openssl rand -base64 32)" >> .env

      - name: Build and start services
        run: |
          docker compose build
          docker compose up -d mysql redis
          
          # Wait for MySQL
          echo "Waiting for MySQL..."
          sleep 30
          
          # Start app services
          docker compose up -d app nginx whatsapp

      - name: Wait for services
        run: |
          echo "Waiting for services to be ready..."
          sleep 30

      - name: Check container status
        run: docker compose ps

      - name: Health check - Nginx
        run: |
          curl -f http://localhost/health || exit 1
          echo "✅ Nginx is healthy"

      - name: Health check - WhatsApp
        run: |
          curl -f http://localhost:3001/health || exit 1
          echo "✅ WhatsApp service is healthy"

      - name: Run Laravel migrations
        run: |
          docker compose exec -T app php artisan migrate --force

      - name: Run Laravel tests
        run: |
          docker compose exec -T app php artisan test --parallel
        continue-on-error: true

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose logs app
          docker compose logs whatsapp
          docker compose logs nginx

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # ==========================================================================
  # Security Scan
  # ==========================================================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: [build-app, build-whatsapp]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build images for scanning
        run: |
          docker compose build app whatsapp

      - name: Run Trivy vulnerability scanner on app
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'blazz/app:latest'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'

      - name: Run Trivy vulnerability scanner on whatsapp
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'blazz/whatsapp:latest'
          format: 'table'
          exit-code: '0'
          severity: 'CRITICAL,HIGH'
